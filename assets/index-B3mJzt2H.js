import{x,m as q,n as y,o as E,p as o,v as L,L as K,q as c,s as B}from"./index--k2p_Bwh.js";x();x();x();var $={EBADF:8,EBADFD:127,EEXIST:20,EINVAL:28,EISDIR:31,ENODEV:43,ENOENT:44,ENOTDIR:54,ENOTEMPTY:55},w=class extends Error{constructor(d,e){super(e),typeof d=="number"?this.code=d:typeof d=="string"&&(this.code=$[d])}},Y=(d,e)=>{let r=d.FS,i={tryFSOperation(t){try{return t()}catch(a){throw a.code?a.code==="UNKNOWN"?new r.ErrnoError($.EINVAL):new r.ErrnoError(a.code):a}},mount(t){return i.createNode(null,"/",16895,0)},syncfs(t,a,s){},createNode(t,a,s,n){if(!r.isDir(s)&&!r.isFile(s))throw new r.ErrnoError(28);let l=r.createNode(t,a,s);return l.node_ops=i.node_ops,l.stream_ops=i.stream_ops,l},getMode:function(t){return i.tryFSOperation(()=>e.lstat(t).mode)},realPath:function(t){let a=[];for(;t.parent!==t;)a.push(t.name),t=t.parent;return a.push(t.mount.opts.root),a.reverse(),a.join("/")},node_ops:{getattr(t){m("getattr",i.realPath(t));let a=i.realPath(t);return i.tryFSOperation(()=>{let s=e.lstat(a);return{...s,dev:0,ino:t.id,nlink:1,rdev:t.rdev,atime:new Date(s.atime),mtime:new Date(s.mtime),ctime:new Date(s.ctime)}})},setattr(t,a){m("setattr",i.realPath(t),a);let s=i.realPath(t);i.tryFSOperation(()=>{a.mode!==void 0&&e.chmod(s,a.mode),a.size!==void 0&&e.truncate(s,a.size),a.timestamp!==void 0&&e.utimes(s,a.timestamp,a.timestamp),a.size!==void 0&&e.truncate(s,a.size)})},lookup(t,a){m("lookup",i.realPath(t),a);let s=[i.realPath(t),a].join("/"),n=i.getMode(s);return i.createNode(t,a,n)},mknod(t,a,s,n){m("mknod",i.realPath(t),a,s,n);let l=i.createNode(t,a,s,n),p=i.realPath(l);return i.tryFSOperation(()=>(r.isDir(l.mode)?e.mkdir(p,{mode:s}):e.writeFile(p,"",{mode:s}),l))},rename(t,a,s){m("rename",i.realPath(t),i.realPath(a),s);let n=i.realPath(t),l=[i.realPath(a),s].join("/");i.tryFSOperation(()=>{e.rename(n,l)}),t.name=s},unlink(t,a){m("unlink",i.realPath(t),a);let s=[i.realPath(t),a].join("/");try{e.unlink(s)}catch{}},rmdir(t,a){m("rmdir",i.realPath(t),a);let s=[i.realPath(t),a].join("/");return i.tryFSOperation(()=>{e.rmdir(s)})},readdir(t){m("readdir",i.realPath(t));let a=i.realPath(t);return i.tryFSOperation(()=>e.readdir(a))},symlink(t,a,s){throw m("symlink",i.realPath(t),a,s),new r.ErrnoError(63)},readlink(t){throw m("readlink",i.realPath(t)),new r.ErrnoError(63)}},stream_ops:{open(t){m("open stream",i.realPath(t.node));let a=i.realPath(t.node);return i.tryFSOperation(()=>{r.isFile(t.node.mode)&&(t.shared.refcount=1,t.nfd=e.open(a))})},close(t){return m("close stream",i.realPath(t.node)),i.tryFSOperation(()=>{r.isFile(t.node.mode)&&t.nfd&&--t.shared.refcount===0&&e.close(t.nfd)})},dup(t){m("dup stream",i.realPath(t.node)),t.shared.refcount++},read(t,a,s,n,l){return m("read stream",i.realPath(t.node),s,n,l),n===0?0:i.tryFSOperation(()=>e.read(t.nfd,a,s,n,l))},write(t,a,s,n,l){return m("write stream",i.realPath(t.node),s,n,l),i.tryFSOperation(()=>e.write(t.nfd,a.buffer,s,n,l))},llseek(t,a,s){m("llseek stream",i.realPath(t.node),a,s);let n=a;if(s===1?n+=t.position:s===2&&r.isFile(t.node.mode)&&i.tryFSOperation(()=>{let l=e.fstat(t.nfd);n+=l.size}),n<0)throw new r.ErrnoError(28);return n},mmap(t,a,s,n,l){if(m("mmap stream",i.realPath(t.node),a,s,n,l),!r.isFile(t.node.mode))throw new r.ErrnoError($.ENODEV);let p=d.mmapAlloc(a);return i.stream_ops.read(t,d.HEAP8,p,a,s),{ptr:p,allocated:!0}},msync(t,a,s,n,l){return m("msync stream",i.realPath(t.node),s,n,l),i.stream_ops.write(t,a,0,n,s),0}}};return i};function m(...d){}x();var G="state.txt",Q="data",H={DIR:16384,FILE:32768},W,v,b,I,T,u,O,S,j,D,F,k,h,C,N,M,g,f,_,J,R,U=class V{constructor({root:e,initialPoolSize:r,maintainedPoolSize:i}){y(this,h),y(this,W,!1),y(this,v),y(this,b),y(this,I),y(this,T),y(this,u),y(this,O,new Map),y(this,S,new Map),y(this,j,0),y(this,D,new Map),y(this,F,new Map),this.lastCheckpoint=0,this.checkpointInterval=1e3*60,this.poolCounter=0,y(this,k,new Set),this.root=e,this.initialPoolSize=r||1e3,this.maintainedPoolSize=i||100,this.readyPromise=c(this,h,C).call(this)}static async create(e){let r=new V(e);return await r.readyPromise,r}get ready(){return o(this,W)}async maintainPool(e){e=e||this.maintainedPoolSize;let r=e-this.state.pool.length,i=[];for(let t=0;t<r;t++)i.push(new Promise(async a=>{++this.poolCounter;let s=`${(Date.now()-1704063600).toString(16).padStart(8,"0")}-${this.poolCounter.toString(16).padStart(8,"0")}`,n=await o(this,I).getFileHandle(s,{create:!0}),l=await n.createSyncAccessHandle();o(this,O).set(s,n),o(this,S).set(s,l),c(this,h,M).call(this,{opp:"createPoolFile",args:[s]}),this.state.pool.push(s),a()}));for(let t=0;t>r;t--)i.push(new Promise(async a=>{let s=this.state.pool.pop();c(this,h,M).call(this,{opp:"deletePoolFile",args:[s]});let n=o(this,O).get(s);o(this,S).get(s)?.close(),await n.remove().then(()=>{o(this,O).delete(s),o(this,S).delete(s),a()})}));await Promise.all(i)}_createPoolFileState(e){this.state.pool.push(e)}_deletePoolFileState(e){let r=this.state.pool.indexOf(e);r>-1&&this.state.pool.splice(r,1)}async maybeCheckpointState(){Date.now()-this.lastCheckpoint>this.checkpointInterval&&await this.checkpointState()}async checkpointState(){let e=new TextEncoder().encode(JSON.stringify(this.state));o(this,u).truncate(0),o(this,u).write(e,{at:0}),o(this,u).flush(),this.lastCheckpoint=Date.now()}flush(){for(let e of o(this,k))try{e.flush()}catch{}o(this,k).clear()}exit(){for(let e of o(this,S).values())e.close();o(this,u).flush(),o(this,u).close()}chmod(e,r){c(this,h,N).call(this,{opp:"chmod",args:[e,r]},()=>{this._chmodState(e,r)})}_chmodState(e,r){let i=c(this,h,f).call(this,e);i.mode=r}close(e){let r=c(this,h,_).call(this,e);o(this,D).delete(e),o(this,F).delete(r)}fstat(e){let r=c(this,h,_).call(this,e);return this.lstat(r)}lstat(e){let r=c(this,h,f).call(this,e),i=r.type==="file"?o(this,S).get(r.backingFilename).getSize():0,t=4096;return{dev:0,ino:0,mode:r.mode,nlink:1,uid:0,gid:0,rdev:0,size:i,blksize:t,blocks:Math.ceil(i/t),atime:r.lastModified,mtime:r.lastModified,ctime:r.lastModified}}mkdir(e,r){c(this,h,N).call(this,{opp:"mkdir",args:[e,r]},()=>{this._mkdirState(e,r)})}_mkdirState(e,r){let i=c(this,h,g).call(this,e),t=i.pop(),a=[],s=this.state.root;for(let l of i){if(a.push(e),!Object.prototype.hasOwnProperty.call(s.children,l))if(r?.recursive)this.mkdir(a.join("/"));else throw new w("ENOENT","No such file or directory");if(s.children[l].type!=="directory")throw new w("ENOTDIR","Not a directory");s=s.children[l]}if(Object.prototype.hasOwnProperty.call(s.children,t))throw new w("EEXIST","File exists");let n={type:"directory",lastModified:Date.now(),mode:r?.mode||H.DIR,children:{}};s.children[t]=n}open(e,r,i){if(c(this,h,f).call(this,e).type!=="file")throw new w("EISDIR","Is a directory");let t=c(this,h,J).call(this);return o(this,D).set(t,e),o(this,F).set(e,t),t}readdir(e){let r=c(this,h,f).call(this,e);if(r.type!=="directory")throw new w("ENOTDIR","Not a directory");return Object.keys(r.children)}read(e,r,i,t,a){let s=c(this,h,_).call(this,e),n=c(this,h,f).call(this,s);if(n.type!=="file")throw new w("EISDIR","Is a directory");return o(this,S).get(n.backingFilename).read(new Int8Array(r.buffer,i,t),{at:a})}rename(e,r){c(this,h,N).call(this,{opp:"rename",args:[e,r]},()=>{this._renameState(e,r,!0)})}_renameState(e,r,i=!1){let t=c(this,h,g).call(this,e),a=t.pop(),s=c(this,h,f).call(this,t.join("/"));if(!Object.prototype.hasOwnProperty.call(s.children,a))throw new w("ENOENT","No such file or directory");let n=c(this,h,g).call(this,r),l=n.pop(),p=c(this,h,f).call(this,n.join("/"));if(i&&Object.prototype.hasOwnProperty.call(p.children,l)){let P=p.children[l];o(this,S).get(P.backingFilename).truncate(0),this.state.pool.push(P.backingFilename)}p.children[l]=s.children[a],delete s.children[a]}rmdir(e){c(this,h,N).call(this,{opp:"rmdir",args:[e]},()=>{this._rmdirState(e)})}_rmdirState(e){let r=c(this,h,g).call(this,e),i=r.pop(),t=c(this,h,f).call(this,r.join("/"));if(!Object.prototype.hasOwnProperty.call(t.children,i))throw new w("ENOENT","No such file or directory");let a=t.children[i];if(a.type!=="directory")throw new w("ENOTDIR","Not a directory");if(Object.keys(a.children).length>0)throw new w("ENOTEMPTY","Directory not empty");delete t.children[i]}truncate(e,r=0){let i=c(this,h,f).call(this,e);if(i.type!=="file")throw new w("EISDIR","Is a directory");let t=o(this,S).get(i.backingFilename);if(!t)throw new w("ENOENT","No such file or directory");t.truncate(r),o(this,k).add(t)}unlink(e){c(this,h,N).call(this,{opp:"unlink",args:[e]},()=>{this._unlinkState(e,!0)})}_unlinkState(e,r=!1){let i=c(this,h,g).call(this,e),t=i.pop(),a=c(this,h,f).call(this,i.join("/"));if(!Object.prototype.hasOwnProperty.call(a.children,t))throw new w("ENOENT","No such file or directory");let s=a.children[t];if(s.type!=="file")throw new w("EISDIR","Is a directory");if(delete a.children[t],r){let n=o(this,S).get(s.backingFilename);n?.truncate(0),o(this,k).add(n),o(this,F).has(e)&&(o(this,D).delete(o(this,F).get(e)),o(this,F).delete(e))}this.state.pool.push(s.backingFilename)}utimes(e,r,i){c(this,h,N).call(this,{opp:"utimes",args:[e,r,i]},()=>{this._utimesState(e,r,i)})}_utimesState(e,r,i){let t=c(this,h,f).call(this,e);t.lastModified=i}writeFile(e,r,i){let t=c(this,h,g).call(this,e),a=t.pop(),s=c(this,h,f).call(this,t.join("/"));if(Object.prototype.hasOwnProperty.call(s.children,a)){let p=s.children[a];p.lastModified=Date.now(),c(this,h,M).call(this,{opp:"setLastModified",args:[e,p.lastModified]})}else{if(this.state.pool.length===0)throw new Error("No more file handles available in the pool");let p={type:"file",lastModified:Date.now(),mode:i?.mode||H.FILE,backingFilename:this.state.pool.pop()};s.children[a]=p,c(this,h,M).call(this,{opp:"createFileNode",args:[e,p]})}let n=s.children[a],l=o(this,S).get(n.backingFilename);r.length>0&&(l.write(typeof r=="string"?new TextEncoder().encode(r):new Int8Array(r),{at:0}),e.startsWith("/pg_wal")&&o(this,k).add(l))}_createFileNodeState(e,r){let i=c(this,h,g).call(this,e),t=i.pop(),a=c(this,h,f).call(this,i.join("/"));a.children[t]=r;let s=this.state.pool.indexOf(r.backingFilename);return s>-1&&this.state.pool.splice(s,1),r}_setLastModifiedState(e,r){let i=c(this,h,f).call(this,e);i.lastModified=r}write(e,r,i,t,a){let s=c(this,h,_).call(this,e),n=c(this,h,f).call(this,s);if(n.type!=="file")throw new w("EISDIR","Is a directory");let l=o(this,S).get(n.backingFilename);if(!l)throw new w("EBADF","Bad file descriptor");let p=l.write(new Int8Array(r,i,t),{at:a});return s.startsWith("/pg_wal")&&o(this,k).add(l),p}};W=new WeakMap,v=new WeakMap,b=new WeakMap,I=new WeakMap,T=new WeakMap,u=new WeakMap,O=new WeakMap,S=new WeakMap,j=new WeakMap,D=new WeakMap,F=new WeakMap,k=new WeakMap,h=new WeakSet,C=async function(){E(this,v,await navigator.storage.getDirectory()),E(this,b,await c(this,h,R).call(this,this.root,{create:!0})),E(this,I,await c(this,h,R).call(this,Q,{from:o(this,b),create:!0})),E(this,T,await o(this,b).getFileHandle(G,{create:!0})),E(this,u,await o(this,T).createSyncAccessHandle());let d=new ArrayBuffer(o(this,u).getSize());o(this,u).read(d,{at:0});let e,r=new TextDecoder().decode(d).split(`
`),i=!1;try{e=JSON.parse(r[0])}catch{e={root:{type:"directory",lastModified:Date.now(),mode:H.DIR,children:{}},pool:[]},o(this,u).truncate(0),o(this,u).write(new TextEncoder().encode(JSON.stringify(e)),{at:0}),i=!0}this.state=e;let t=r.slice(1).filter(Boolean).map(l=>JSON.parse(l));for(let l of t){let p=`_${l.opp}State`;if(typeof this[p]=="function")try{this[p].bind(this)(...l.args)}catch(P){console.warn("Error applying OPFS AHP WAL entry",l,P)}}let a=[],s=async l=>{if(l.type==="file")try{let p=await o(this,I).getFileHandle(l.backingFilename),P=await p.createSyncAccessHandle();o(this,O).set(l.backingFilename,p),o(this,S).set(l.backingFilename,P)}catch(p){console.error("Error opening file handle for node",l,p)}else for(let p of Object.values(l.children))a.push(s(p))};await s(this.state.root);let n=[];for(let l of this.state.pool)n.push(new Promise(async p=>{o(this,O).has(l)&&console.warn("File handle already exists for pool file",l);let P=await o(this,I).getFileHandle(l),X=await P.createSyncAccessHandle();o(this,O).set(l,P),o(this,S).set(l,X),p()}));await Promise.all([...a,...n]),await this.maintainPool(i?this.initialPoolSize:this.maintainedPoolSize),E(this,W,!0)},N=function(d,e){let r=c(this,h,M).call(this,d);try{e()}catch(i){throw o(this,u).truncate(r),i}},M=function(d){let e=JSON.stringify(d),r=new TextEncoder().encode(`
${e}`),i=o(this,u).getSize();return o(this,u).write(r,{at:i}),o(this,k).add(o(this,u)),i},g=function(d){return d.split("/").filter(Boolean)},f=function(d,e){let r=c(this,h,g).call(this,d),i=e||this.state.root;for(let t of r){if(i.type!=="directory")throw new w("ENOTDIR","Not a directory");if(!Object.prototype.hasOwnProperty.call(i.children,t))throw new w("ENOENT","No such file or directory");i=i.children[t]}return i},_=function(d){let e=o(this,D).get(d);if(!e)throw new w("EBADF","Bad file descriptor");return e},J=function(){let d=++B(this,j)._;for(;o(this,D).has(d);)B(this,j)._++;return d},R=async function(d,e){let r=c(this,h,g).call(this,d),i=e?.from||o(this,v);for(let t of r)i=await i.getDirectoryHandle(t,{create:e?.create});return i};var Z=U,A,z,et=class extends q{constructor(d,{initialPoolSize:e,maintainedPoolSize:r}={}){super(d),y(this,A),y(this,z),E(this,A,e??1e3),E(this,z,r??100)}async emscriptenOpts(d){return this.opfsAhp=await Z.create({root:this.dataDir,initialPoolSize:o(this,A),maintainedPoolSize:o(this,z)}),{...d,preRun:[...d.preRun||[],e=>{let r=Y(e,this.opfsAhp);e.FS.mkdir(L),e.FS.mount(r,{},L)}]}}async syncToFs(d,e=!1){await this.opfsAhp?.maybeCheckpointState(),await this.opfsAhp?.maintainPool(),e||this.opfsAhp?.flush()}async dumpTar(d,e,r){return K(d,e,r)}async close(d){this.opfsAhp?.exit(),d.quit()}};A=new WeakMap,z=new WeakMap;export{et as OpfsAhpFS};
